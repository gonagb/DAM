<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semana 5 de Servicios y Procesos</title>

    <style>
        html, body {
            padding: 0px;
            margin: 0px;
            overflow: hidden;
        }
        canvas {
            border: 1px solid grey;
            image-rendering: optimizeSpeed;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: pixelated;
            image-rendering: optimize-contrast;
        }
    </style>
</head>
<body>
    <!-- 
        
        Vamos a realizar el juego de la vida, estas son las reglas: 

        - Una célula muerta con exactamente 3 células vecinas vivas "nace" (es decir, al turno siguiente estará viva)
        - Una célula viva con 2 o 3 células vecinas vivas, sigue viva, en otro caso muere (por soledad o superpoblación)
    
    -->

    <canvas id="lienzo" width="512" height="512"></canvas>

    <script>
        // Obtener el ancho y alto de la ventana
        var anchura = window.innerWidth; 
        var altura = window.innerHeight;

        // Establecer el tamaño del lienzo al tamaño de la ventana
        document.getElementById("lienzo").width = anchura;
        document.getElementById("lienzo").height = altura;

        // Obtener el contexto del lienzo
        var contexto = document.getElementById("lienzo").getContext("2d");

        // Carga inicial de pixeles negros y blancos al azar
        contexto.fillStyle = "rgb(255,255,255)";
        contexto.fillRect(0, 0, anchura, altura);

        // Obtener los datos del lienzo
        var datoscanvas = contexto.getImageData(0, 0, anchura, altura);

        // Inicializar el lienzo con pixeles negros o blancos al azar
        for (var i = 0; i < datoscanvas.data.length; i += 4) {
            if (Math.random() < 0.2) {
                datoscanvas.data[i] = 0;
                datoscanvas.data[i+1] = 0;
                datoscanvas.data[i+2] = 0;
            } else {
                datoscanvas.data[i] = 255;
                datoscanvas.data[i+1] = 255;
                datoscanvas.data[i+2] = 255;
                datoscanvas.data[i+3] = 255;
            }
        }

        // Aplicar los datos al lienzo
        contexto.putImageData(datoscanvas, 0, 0);

        // Configurar múltiples trabajadores para procesar datos
        var numeroworkers = window.navigator.hardwareConcurrency * 10;
        var trabajador = new Array();

        // Iniciar múltiples trabajadores
        for (var i = 0; i < numeroworkers; i++) {
            trabajador[i] = new Worker("trabajador.js");

            // Inicializar variables x, y y datos
            var x = 0;
            var y = 0;
            var datos = "";

            // Encontrar una ubicación con celdas vacías
            while (true) {
                x = Math.round(Math.random() * anchura);
                y = Math.round(Math.random() * altura);
                datos = contexto.getImageData(x, y, 3, 3);
                var suma = 0;
                for (var j = 0; j < datos.data.length; j += 4) {
                    suma += datos.data[j];
                }
                if (suma < 255 * 9 - 255) {
                    break;
                }
            }

            // Crear objeto JSON con los datos y coordenadas
            var json = { "datos": datos, x: x, y: y };

            // Enviar el objeto JSON al trabajador
            trabajador[i].postMessage(json);

            // Configurar el manejador de mensajes para cada trabajador
            trabajador[i].onmessage = function (datos) {
                // Actualizar el lienzo según el resultado del trabajador
                if (datos.data.datos == true) {
                    contexto.fillStyle = "black";
                    contexto.fillRect(datos.data.x + 1, datos.data.y + 1, 1, 1);
                } else {
                    contexto.fillStyle = "white";
                    contexto.fillRect(datos.data.x + 1, datos.data.y + 1, 1, 1);
                }
                // Encontrar una nueva ubicación con celdas vacías
                x = Math.round(Math.random() * anchura);
                y = Math.round(Math.random() * altura);
                datos = contexto.getImageData(x, y, 3, 3);
                json = { "datos": datos, x: x, y: y };
                this.postMessage(json);
            }
        }
    </script>
</body>
</html>
